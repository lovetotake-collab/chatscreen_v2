<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ ê¸°ë¡ í†µê³„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stock-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        
        .stock-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .summary-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-calculate {
            background: #ff9800;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-calculate:hover {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,152,0,0.3);
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
            padding: 8px 15px;
        }
        
        .btn-delete:hover {
            background: #da190b;
        }
        
        .btn-delete-row {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            padding: 8px 12px;
            font-size: 0.9em;
        }
        
        .btn-delete-row:hover {
            background: #da190b;
        }
        
        .btn-add-buy, .btn-add-sell {
            width: 100%;
            color: white;
            transition: all 0.3s;
        }
        
        .btn-add-buy {
            background: #4caf50;
        }
        
        .btn-add-buy:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-add-sell {
            background: #2196f3;
        }
        
        .btn-add-sell:hover {
            background: #1976d2;
            transform: translateY(-1px);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-export {
            background: #2e7d32;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-export:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46,125,50,0.3);
        }
        
        .btn-reset {
            background: #9e9e9e;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-reset:hover {
            background: #757575;
        }
        
        /* íŒŒìŠ¤í…” ë°°ê²½ìƒ‰ */
        .buy-section {
            background: #ffebee !important;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sell-section {
            background: #e3f2fd !important;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .buy-section h4 {
            color: #c62828 !important;
        }
        
        .sell-section h4 {
            color: #1565c0 !important;
        }
        
        .trade-row {
            display: grid;
            grid-template-columns: auto 120px 100px 120px 120px auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .trade-label {
            font-weight: bold;
            color: #333;
            padding: 10px;
        }
        
        .sell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sell-profit-info {
            font-size: 1.1em;
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 5px;
            background: white;
        }
        
        /* ì „ì²´ í†µê³„ */
        .total-stats {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffc107;
            margin-bottom: 20px;
        }
        
        .total-stats h3 {
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .stats-summary:last-child {
            grid-template-columns: repeat(7, 1fr);
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        /* í†µê³„ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        
        .stats-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-size: 0.9em;
            border: 1px solid #5568d3;
        }
        
        .stats-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        
        .stats-table tr:hover {
            background: #f0f0f0;
        }
        
        .stats-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .stats-table tbody tr:hover {
            background: #e3f2fd;
        }
        
        .profit-text {
            color: #f44336;
            font-weight: bold;
        }
        
        .loss-text {
            color: #2196f3;
            font-weight: bold;
        }
        
        .break-even-text {
            color: #333;
            font-weight: bold;
        }
        
        /* ì‹œì´ê·œëª¨ë³„ í–‰ ìƒ‰ìƒ */
        .row-ì‹ ê·œì£¼ {
            background-color: #d4edda !important;
        }
        
        .row-ì„¸ë ¥ì£¼ {
            background-color: #ffffff !important;
        }
        
        .row-ë°˜ìˆ˜ê¸‰ì£¼ {
            background-color: #ffe4c4 !important;
        }
        
        .row-ì´ˆëŒ€í˜•ì£¼ {
            background-color: #e9ecef !important;
        }
        
        /* êµ¬ê¸€ ì—°ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-google:hover {
            background: #357ae8;
            transform: translateY(-1px);
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-backup:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-load:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .sync-status.disconnected {
            background: #fee;
            color: #c33;
        }
        
        .sync-status.connected {
            background: #efe;
            color: #3c3;
        }
        
        .sync-status.syncing {
            background: #ffc;
            color: #cc6;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        @media (max-width: 1200px) {
            .stats-summary {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .stats-summary:last-child {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .stock-header {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-summary:last-child {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stock-header {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .trade-row {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ë§¤ë§¤ ê¸°ë¡ í†µê³„</h1>
        
        <div class="header-buttons">
            <div class="sync-status disconnected" id="syncStatus">
                <span class="sync-dot"></span>
                <span id="statusText">ì—°ê²° ì•ˆë¨</span>
            </div>
            <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                <span>ğŸ’¾</span>
                <span>ë°±ì—…</span>
            </button>
            <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                <span>ğŸ“¥</span>
                <span>ë¡œë“œ</span>
            </button>
            <button id="googleBtn" class="btn-google" onclick="handleAuthClick()">
                <span>ğŸ”</span>
                <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
            </button>
        </div>
        
        <div class="card">
            <h2>ğŸ’¼ ì¢…ëª©ë³„ ë§¤ë§¤ ê¸°ë¡</h2>
            
            <div id="stockInput"></div>
            
            <button class="btn-calculate" onclick="calculateAndAdd()">ğŸ“ˆ ê°œë³„ì¢…ëª©ê³„ì‚°</button>
            
            <div class="action-buttons">
                <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn-reset" onclick="resetAll()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <div class="card" id="statsCard" style="display: none;">
            <div class="total-stats">
                <h3>ğŸ¯ ì „ì²´ í†µê³„</h3>
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-label">ì´ ê±°ë˜ ì¢…ëª©</div>
                        <div class="stat-value" id="totalStocks">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ì´ íˆ¬ìê¸ˆì•¡</div>
                        <div class="stat-value" id="totalInvest">0ì›</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ì´ ìˆ˜ìµê¸ˆ</div>
                        <div class="stat-value" id="totalProfit">0ì›</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">í‰ê·  ìˆ˜ìµë¥ </div>
                        <div class="stat-value" id="avgReturn">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìŠ¹ë¥ </div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìµœê³  ìˆ˜ìµë¥ </div>
                        <div class="stat-value" id="maxProfitRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìµœëŒ€ ì†ì‹¤ë¥ </div>
                        <div class="stat-value" id="maxLossRate">0%</div>
                    </div>
                </div>
                
                <div class="stats-summary" style="margin-top: 15px;">
                    <div class="stat-item">
                        <div class="stat-label">í‰ê·  ë§¤ë§¤ê¸°ê°„</div>
                        <div class="stat-value" id="avgTradePeriod">0ì¼</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">í‰ê·  1ì°¨ë§¤ìˆ˜ê¸°ê°„</div>
                        <div class="stat-value" id="avgFirstBuyPeriod">0ì¼</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">í‰ê·  ë§¤ìˆ˜ì°¨ìˆ˜</div>
                        <div class="stat-value" id="avgBuyCount">0íšŒ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ìµœëŒ€ ë§¤ìˆ˜ì°¨ìˆ˜</div>
                        <div class="stat-value" id="maxBuyCount">0íšŒ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">1ë“± ì°¨ìˆ˜</div>
                        <div class="stat-value" id="topBuyCount">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">2ë“± ì°¨ìˆ˜</div>
                        <div class="stat-value" id="secondBuyCount">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">3ë“± ì°¨ìˆ˜</div>
                        <div class="stat-value" id="thirdBuyCount">-</div>
                    </div>
                </div>
            </div>
            
            <h2>ğŸ“‹ í†µê³„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸</h2>
            
            <div style="margin-bottom: 15px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                <div>
                    <label style="font-size: 0.9em;">ê¸°ë²•ëª… í•„í„°</label>
                    <select id="filterStrategy" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="ì„¸ë ¥ì£¼ì›ë¦¬ìŠ¤ìœ™">ì„¸ë ¥ì£¼ì›ë¦¬ìŠ¤ìœ™</option>
                        <option value="ì‚¼ì‹œí™•">ì‚¼ì‹œí™•</option>
                        <option value="Fì¡´">Fì¡´</option>
                        <option value="SM10">SM10</option>
                        <option value="SM3">SM3</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.9em;">ì‹œì´ê·œëª¨ í•„í„°</label>
                    <select id="filterMarketCap" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="ì‹ ê·œì£¼">ì‹ ê·œì£¼</option>
                        <option value="ì„¸ë ¥ì£¼">ì„¸ë ¥ì£¼</option>
                        <option value="ë°˜ìˆ˜ê¸‰ì£¼">ë°˜ìˆ˜ê¸‰ì£¼</option>
                        <option value="ì´ˆëŒ€í˜•ì£¼">ì´ˆëŒ€í˜•ì£¼</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.9em;">ë“±ìˆ˜ í•„í„°</label>
                    <select id="filterRank" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="ëŒ€ì¥">ëŒ€ì¥</option>
                        <option value="2ë“±">2ë“±</option>
                        <option value="3ë“±">3ë“±</option>
                        <option value="ê°œë³„">ê°œë³„</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.9em;">ì‹ ê³ ê°€ í•„í„°</label>
                    <select id="filterHighType" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="120ì¼">120ì¼</option>
                        <option value="240ì¼">240ì¼</option>
                        <option value="480ì¼">480ì¼</option>
                        <option value="ì—­ì‚¬ì ì‹ ê³ ê°€">ì—­ì‚¬ì ì‹ ê³ ê°€</option>
                        <option value="ë°•ìŠ¤ê¶Œ">ë°•ìŠ¤ê¶Œ</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.9em;">ì—”ë²¨ì •ì°© í•„í„°</label>
                    <select id="filterEnvelope" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="Y">Y</option>
                        <option value="N">N</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.9em;">ìˆ˜ìµì—¬ë¶€ í•„í„°</label>
                    <select id="filterProfit" onchange="applyFilters()">
                        <option value="">ì „ì²´</option>
                        <option value="O">ìˆ˜ìµ</option>
                        <option value="â–²">ë³¸ì „</option>
                        <option value="X">ì†ì‹¤</option>
                    </select>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>ê¸°ë²•ëª…</th>
                            <th>ì‹œì´ê·œëª¨</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ë“±ìˆ˜</th>
                            <th>ì‹ ê³ ê°€</th>
                            <th>ì—”ë²¨ì •ì°©</th>
                            <th>ì²«ë§¤ìˆ˜ê¸°ê°„</th>
                            <th>ë§¤ë§¤ê¸°ê°„</th>
                            <th>ë§¤ìˆ˜ì°¨ìˆ˜</th>
                            <th>ì´ë§¤ìˆ˜ê¸ˆì•¡</th>
                            <th>ìˆ˜ìµë¥ </th>
                            <th>ìˆ˜ìµê¸ˆ</th>
                            <th>ìˆ˜ìµì—¬ë¶€</th>
                            <th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let stockData = [];
        
        // ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼ (2024-2026)
        const holidays = [
            '2024-01-01', '2024-02-09', '2024-02-10', '2024-02-11', '2024-02-12',
            '2024-03-01', '2024-04-10', '2024-05-05', '2024-05-06', '2024-05-15',
            '2024-06-06', '2024-08-15', '2024-09-16', '2024-09-17', '2024-09-18',
            '2024-10-03', '2024-10-09', '2024-12-25',
            '2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-03-01',
            '2025-03-03', '2025-05-05', '2025-05-06', '2025-06-06', '2025-08-15',
            '2025-10-03', '2025-10-05', '2025-10-06', '2025-10-07', '2025-10-09',
            '2025-12-25',
            '2026-01-01', '2026-02-16', '2026-02-17', '2026-02-18', '2026-03-01',
            '2026-04-05', '2026-05-05', '2026-05-25', '2026-06-06', '2026-08-15',
            '2026-09-24', '2026-09-25', '2026-09-26', '2026-10-03', '2026-10-09',
            '2026-12-25'
        ];
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function calculateBusinessDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) return 0;
            
            let count = 0;
            const current = new Date(start);
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                const dateStr = formatDate(current);
                
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidays.includes(dateStr)) {
                    count++;
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            return count - 1;
        }
        
        function autoFormatDate(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            
            if (value.length === 6) {
                const year = '20' + value.substring(0, 2);
                const month = value.substring(2, 4);
                const day = value.substring(4, 6);
                input.value = `${year}-${month}-${day}`;
                
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }
        }
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        function parseNumber(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }
        
        function formatInput(input) {
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            const numValue = oldValue.replace(/,/g, '');
            if (numValue === '') {
                input.value = '';
                return;
            }
            
            const cleanValue = numValue.replace(/[^\d.]/g, '');
            if (cleanValue === '') {
                input.value = '';
                return;
            }
            
            const parts = cleanValue.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const formatted = parts.join('.');
            
            input.value = formatted;
            
            try {
                const newLength = formatted.length;
                const diff = newLength - oldLength;
                input.setSelectionRange(cursorPos + diff, cursorPos + diff);
            } catch (e) {}
        }
        
        function createStockInput() {
            const stockInput = document.getElementById('stockInput');
            
            stockInput.innerHTML = `
                <div class="stock-item">
                    <div class="stock-header">
                        <div>
                            <label>ê¸°ë²•ëª…</label>
                            <select id="strategyName">
                                <option value="">ì„ íƒ</option>
                                <option value="ì„¸ë ¥ì£¼ì›ë¦¬ìŠ¤ìœ™">ì„¸ë ¥ì£¼ì›ë¦¬ìŠ¤ìœ™</option>
                                <option value="ì‚¼ì‹œí™•">ì‚¼ì‹œí™•</option>
                                <option value="Fì¡´">Fì¡´</option>
                                <option value="SM10">SM10</option>
                                <option value="SM3">SM3</option>
                            </select>
                        </div>
                        <div>
                            <label>ì‹œì´ê·œëª¨</label>
                            <select id="marketCap">
                                <option value="">ì„ íƒ</option>
                                <option value="ì‹ ê·œì£¼">ì‹ ê·œì£¼</option>
                                <option value="ì„¸ë ¥ì£¼">ì„¸ë ¥ì£¼</option>
                                <option value="ë°˜ìˆ˜ê¸‰ì£¼">ë°˜ìˆ˜ê¸‰ì£¼</option>
                                <option value="ì´ˆëŒ€í˜•ì£¼">ì´ˆëŒ€í˜•ì£¼</option>
                            </select>
                        </div>
                        <div>
                            <label>ì¢…ëª©ëª…</label>
                            <input type="text" id="stockName" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
                        </div>
                        <div>
                            <label>ë“±ìˆ˜</label>
                            <select id="rank">
                                <option value="">ì„ íƒ</option>
                                <option value="ëŒ€ì¥">ëŒ€ì¥</option>
                                <option value="2ë“±">2ë“±</option>
                                <option value="3ë“±">3ë“±</option>
                                <option value="ê°œë³„">ê°œë³„</option>
                            </select>
                        </div>
                        <div>
                            <label>ì‹ ê³ ê°€</label>
                            <select id="highType">
                                <option value="">ì„ íƒ</option>
                                <option value="120ì¼">120ì¼</option>
                                <option value="240ì¼">240ì¼</option>
                                <option value="480ì¼">480ì¼</option>
                                <option value="ì—­ì‚¬ì ì‹ ê³ ê°€">ì—­ì‚¬ì ì‹ ê³ ê°€</option>
                                <option value="ë°•ìŠ¤ê¶Œ">ë°•ìŠ¤ê¶Œ</option>
                            </select>
                        </div>
                        <div>
                            <label>ì—”ë²¨ì •ì°©ì—¬ë¶€</label>
                            <select id="envelope">
                                <option value="">ì„ íƒ</option>
                                <option value="Y">Y</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div>
                            <label>í¬ì°©ì¼ (ì˜ˆ:250702)</label>
                            <input type="text" id="catchDate" placeholder="250702" maxlength="10">
                        </div>
                    </div>
                    
                    <div class="buy-section">
                        <h4>ğŸ’° ë§¤ìˆ˜ ì •ë³´</h4>
                        
                        <div class="summary-row" id="buySummary" style="display: none;">
                            <div class="summary-item">
                                <div class="summary-label">ë§¤ìˆ˜íšŸìˆ˜</div>
                                <div class="summary-value" id="buyCount">0íšŒ</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ì´ë§¤ìˆ˜ê¸ˆì•¡</div>
                                <div class="summary-value" id="buyTotalAmount">0ì›</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">í‰ë‹¨ê°€</div>
                                <div class="summary-value" id="buyAvgPrice">0ì›</div>
                            </div>
                        </div>
                        
                        <div id="buyList">
                            <div class="trade-row buy-row">
                                <div class="trade-label">1ì°¨ë§¤ìˆ˜</div>
                                <div>
                                    <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                                    <input type="text" class="buy-date date-input" placeholder="250702" maxlength="10">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">D+ì¼</label>
                                    <input type="text" class="buy-dday" readonly style="background: #f5f5f5;">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                                    <input type="text" class="buy-price" placeholder="ê°€ê²©" inputmode="numeric">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">ë§¤ìˆ˜ê¸ˆì•¡</label>
                                    <input type="text" class="buy-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="display:none;">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-add-buy" onclick="addBuyRow()">+ ë§¤ìˆ˜ ì¶”ê°€</button>
                    </div>
                    
                    <div class="sell-section">
                        <div class="sell-header">
                            <h4 style="margin: 0;">ğŸ’¸ ë§¤ë„ ì •ë³´</h4>
                            <div id="sellProfitInfo" style="display: none;" class="sell-profit-info">
                                <span id="sellProfitRate">0%</span> / <span id="sellProfitAmount">0ì›</span>
                            </div>
                        </div>
                        
                        <div class="summary-row" style="margin-bottom: 15px;">
                            <div class="summary-item" style="grid-column: span 3;">
                                <div class="summary-label">ë‚¨ì€ ë§¤ìˆ˜ë¬¼ëŸ‰ì˜ ì´ê¸ˆì•¡</div>
                                <div class="summary-value" id="remainingBuyAmount">0ì›</div>
                            </div>
                        </div>
                        
                        <div id="sellList">
                            <div class="trade-row sell-row">
                                <div class="trade-label">1ì°¨ë§¤ë„</div>
                                <div>
                                    <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                                    <input type="text" class="sell-date date-input" placeholder="250702" maxlength="10">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">D+ì¼</label>
                                    <input type="text" class="sell-dday" readonly style="background: #f5f5f5;">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                                    <input type="text" class="sell-price" placeholder="ê°€ê²©" inputmode="numeric">
                                </div>
                                <div>
                                    <label style="font-size: 0.85em;">ë§¤ë„ê¸ˆì•¡</label>
                                    <input type="text" class="sell-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="btn-delete-row" onclick="deleteSellRow(this)" style="display:none;">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-add-sell" onclick="addSellRow()">+ ë§¤ë„ ì¶”ê°€</button>
                    </div>
                </div>
            `;
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // í¬ì°©ì¼
            const catchDate = document.getElementById('catchDate');
            catchDate.addEventListener('input', function() {
                autoFormatDate(this);
            });
            catchDate.addEventListener('change', updateAllDdays);
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œë“¤
            const dateInputs = document.querySelectorAll('.date-input');
            dateInputs.forEach(input => {
                input.addEventListener('input', function() {
                    autoFormatDate(this);
                });
                input.addEventListener('change', updateAllDdays);
            });
            
            // ìˆ«ì ì…ë ¥ í•„ë“œ
            const numericInputs = document.querySelectorAll('input[inputmode="numeric"]');
            numericInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    updateSummary();
                });
            });
        }
        
        function updateAllDdays() {
            const catchDate = document.getElementById('catchDate').value;
            
            // ë§¤ìˆ˜ D-day
            const buyRows = document.querySelectorAll('.buy-row');
            buyRows.forEach(row => {
                const buyDate = row.querySelector('.buy-date').value;
                const ddayInput = row.querySelector('.buy-dday');
                if (catchDate && buyDate) {
                    const days = calculateBusinessDays(catchDate, buyDate);
                    ddayInput.value = `D+${days}`;
                } else {
                    ddayInput.value = '';
                }
            });
            
            // ë§¤ë„ D-day (ë§ˆì§€ë§‰ ë§¤ìˆ˜ì¼ ê¸°ì¤€)
            const lastBuyDate = getLastBuyDate();
            const sellRows = document.querySelectorAll('.sell-row');
            sellRows.forEach(row => {
                const sellDate = row.querySelector('.sell-date').value;
                const ddayInput = row.querySelector('.sell-dday');
                if (lastBuyDate && sellDate) {
                    const days = calculateBusinessDays(lastBuyDate, sellDate);
                    ddayInput.value = `D+${days}`;
                } else {
                    ddayInput.value = '';
                }
            });
        }
        
        function getLastBuyDate() {
            const buyRows = document.querySelectorAll('.buy-row');
            let lastDate = null;
            
            buyRows.forEach(row => {
                const date = row.querySelector('.buy-date').value;
                if (date && (!lastDate || date > lastDate)) {
                    lastDate = date;
                }
            });
            
            return lastDate;
        }
        
        function updateSummary() {
            // ë§¤ìˆ˜ ê³„ì‚°
            let totalBuyAmount = 0;
            let totalBuyQty = 0;
            let buyCount = 0;
            
            const buyRows = document.querySelectorAll('.buy-row');
            buyRows.forEach(row => {
                const price = parseNumber(row.querySelector('.buy-price').value);
                const amount = parseNumber(row.querySelector('.buy-amount').value);
                if (amount > 0 && price > 0) {
                    const qty = amount / price;
                    totalBuyAmount += amount;
                    totalBuyQty += qty;
                    buyCount++;
                }
            });
            
            const avgPrice = totalBuyQty > 0 ? totalBuyAmount / totalBuyQty : 0;
            
            // ë§¤ìˆ˜ ìš”ì•½ ì—…ë°ì´íŠ¸
            const buySummary = document.getElementById('buySummary');
            if (buyCount > 0) {
                buySummary.style.display = 'grid';
                document.getElementById('buyCount').textContent = `${buyCount}íšŒ`;
                document.getElementById('buyTotalAmount').textContent = formatNumber(Math.round(totalBuyAmount)) + 'ì›';
                document.getElementById('buyAvgPrice').textContent = formatNumber(Math.round(avgPrice)) + 'ì›';
            } else {
                buySummary.style.display = 'none';
            }
            
            // ë§¤ë„ ê³„ì‚°
            let totalSellAmount = 0;
            let totalSellQty = 0;
            
            const sellRows = document.querySelectorAll('.sell-row');
            sellRows.forEach(row => {
                const price = parseNumber(row.querySelector('.sell-price').value);
                const amount = parseNumber(row.querySelector('.sell-amount').value);
                if (amount > 0) {
                    totalSellAmount += amount;
                    if (price > 0) {
                        const qty = amount / price;
                        totalSellQty += qty;
                    }
                }
            });
            
            // ë‚¨ì€ ë§¤ìˆ˜ë¬¼ëŸ‰ ê¸ˆì•¡ = ì´ë§¤ìˆ˜ê¸ˆì•¡ - ì´ë§¤ë„ê¸ˆì•¡ (ë‹¨ìˆœ ì°¨ì•¡)
            const remainingAmount = totalBuyAmount - totalSellAmount;
            document.getElementById('remainingBuyAmount').textContent = formatNumber(Math.round(remainingAmount)) + 'ì›';
            
            // ìˆ˜ìµê¸ˆ = ì´ë§¤ë„ê¸ˆì•¡ - (í‰ë‹¨ê°€ Ã— ì´ë§¤ë„ìˆ˜ëŸ‰)
            if (totalBuyAmount > 0 && totalSellQty > 0) {
                const profit = totalSellAmount - (avgPrice * totalSellQty);
                const profitRate = ((totalSellAmount / (avgPrice * totalSellQty)) - 1) * 100;
                
                const profitInfo = document.getElementById('sellProfitInfo');
                const profitRateEl = document.getElementById('sellProfitRate');
                const profitAmountEl = document.getElementById('sellProfitAmount');
                
                profitInfo.style.display = 'block';
                profitRateEl.textContent = profitRate.toFixed(2) + '%';
                profitAmountEl.textContent = formatNumber(Math.round(profit)) + 'ì›';
                
                if (profit > 0) {
                    profitRateEl.style.color = '#f44336';
                    profitAmountEl.style.color = '#f44336';
                } else if (profit < 0) {
                    profitRateEl.style.color = '#2196f3';
                    profitAmountEl.style.color = '#2196f3';
                } else {
                    profitRateEl.style.color = '#333';
                    profitAmountEl.style.color = '#333';
                }
            } else {
                document.getElementById('sellProfitInfo').style.display = 'none';
            }
        }
        
        function addBuyRow() {
            const buyList = document.getElementById('buyList');
            const currentRows = buyList.querySelectorAll('.buy-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'trade-row buy-row';
            newRow.innerHTML = `
                <div class="trade-label">${currentRows + 1}ì°¨ë§¤ìˆ˜</div>
                <div>
                    <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                    <input type="text" class="buy-date date-input" placeholder="250702" maxlength="10">
                </div>
                <div>
                    <label style="font-size: 0.85em;">D+ì¼</label>
                    <input type="text" class="buy-dday" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                    <input type="text" class="buy-price" placeholder="ê°€ê²©" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ë§¤ìˆ˜ê¸ˆì•¡</label>
                    <input type="text" class="buy-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn-delete-row" onclick="deleteBuyRow(this)">ì‚­ì œ</button>
                </div>
            `;
            
            buyList.appendChild(newRow);
            setupEventListeners();
            
            const firstDelete = buyList.querySelector('.btn-delete-row');
            if (firstDelete) firstDelete.style.display = 'block';
        }
        
        function deleteBuyRow(button) {
            const buyList = document.getElementById('buyList');
            button.closest('.buy-row').remove();
            
            const rows = buyList.querySelectorAll('.buy-row');
            rows.forEach((row, index) => {
                row.querySelector('.trade-label').textContent = `${index + 1}ì°¨ë§¤ìˆ˜`;
            });
            
            if (rows.length === 1) {
                const deleteBtn = rows[0].querySelector('.btn-delete-row');
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
            
            updateSummary();
            updateAllDdays();
        }
        
        function addSellRow() {
            const sellList = document.getElementById('sellList');
            const currentRows = sellList.querySelectorAll('.sell-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'trade-row sell-row';
            newRow.innerHTML = `
                <div class="trade-label">${currentRows + 1}ì°¨ë§¤ë„</div>
                <div>
                    <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                    <input type="text" class="sell-date date-input" placeholder="250702" maxlength="10">
                </div>
                <div>
                    <label style="font-size: 0.85em;">D+ì¼</label>
                    <input type="text" class="sell-dday" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                    <input type="text" class="sell-price" placeholder="ê°€ê²©" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ë§¤ë„ê¸ˆì•¡</label>
                    <input type="text" class="sell-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn-delete-row" onclick="deleteSellRow(this)">ì‚­ì œ</button>
                </div>
            `;
            
            sellList.appendChild(newRow);
            setupEventListeners();
            
            const firstDelete = sellList.querySelector('.btn-delete-row');
            if (firstDelete) firstDelete.style.display = 'block';
        }
        
        function deleteSellRow(button) {
            const sellList = document.getElementById('sellList');
            button.closest('.sell-row').remove();
            
            const rows = sellList.querySelectorAll('.sell-row');
            rows.forEach((row, index) => {
                row.querySelector('.trade-label').textContent = `${index + 1}ì°¨ë§¤ë„`;
            });
            
            if (rows.length === 1) {
                const deleteBtn = rows[0].querySelector('.btn-delete-row');
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
            
            updateSummary();
            updateAllDdays();
        }
        
        function calculateAndAdd() {
            const strategy = document.getElementById('strategyName').value || '';
            const marketCap = document.getElementById('marketCap').value || '';
            const name = document.getElementById('stockName').value || 'ì¢…ëª©';
            const rank = document.getElementById('rank').value || '';
            const highType = document.getElementById('highType').value || '';
            const envelope = document.getElementById('envelope').value || '';
            const catchDate = document.getElementById('catchDate').value || '';
            
            // ë§¤ìˆ˜ ì •ë³´ ìˆ˜ì§‘
            let totalBuyAmount = 0;
            let totalBuyQty = 0;
            let buyCount = 0;
            let firstBuyDate = null;
            const buyData = [];
            
            const buyRows = document.querySelectorAll('.buy-row');
            buyRows.forEach((row, idx) => {
                const date = row.querySelector('.buy-date').value;
                const dday = row.querySelector('.buy-dday').value;
                const price = parseNumber(row.querySelector('.buy-price').value);
                const amount = parseNumber(row.querySelector('.buy-amount').value);
                
                if (amount > 0 && price > 0) {
                    const qty = amount / price;
                    totalBuyAmount += amount;
                    totalBuyQty += qty;
                    buyCount++;
                    
                    if (!firstBuyDate || date < firstBuyDate) {
                        firstBuyDate = date;
                    }
                    
                    buyData.push({ 
                        ì°¨ìˆ˜: `${idx + 1}ì°¨`, 
                        ë‚ ì§œ: date, 
                        ë””ë°ì´: dday,
                        ë§¤ìˆ˜ê°€: price, 
                        ë§¤ìˆ˜ê¸ˆì•¡: amount 
                    });
                }
            });
            
            if (buyCount === 0) {
                alert('ë§¤ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ë§¤ë„ ì •ë³´ ìˆ˜ì§‘
            let totalSellAmount = 0;
            let totalSellQty = 0;
            let lastSellDate = null;
            const sellData = [];
            
            const sellRows = document.querySelectorAll('.sell-row');
            sellRows.forEach((row, idx) => {
                const date = row.querySelector('.sell-date').value;
                const dday = row.querySelector('.sell-dday').value;
                const price = parseNumber(row.querySelector('.sell-price').value);
                const amount = parseNumber(row.querySelector('.sell-amount').value);
                
                if (amount > 0 && price > 0) {
                    const qty = amount / price;
                    totalSellAmount += amount;
                    totalSellQty += qty;
                    
                    if (!lastSellDate || date > lastSellDate) {
                        lastSellDate = date;
                    }
                    
                    sellData.push({ 
                        ì°¨ìˆ˜: `${idx + 1}ì°¨`, 
                        ë‚ ì§œ: date, 
                        ë””ë°ì´: dday,
                        ë§¤ë„ê°€: price, 
                        ë§¤ë„ê¸ˆì•¡: amount 
                    });
                }
            });
            
            // ê³„ì‚°
            const avgPrice = totalBuyAmount / totalBuyQty;
            const profit = totalSellAmount - (avgPrice * totalSellQty);
            const profitRate = totalSellQty > 0 ? ((totalSellAmount / (avgPrice * totalSellQty)) - 1) * 100 : 0;
            
            // ì²«ë§¤ìˆ˜ê¸°ê°„
            const firstBuyPeriod = catchDate && firstBuyDate ? calculateBusinessDays(catchDate, firstBuyDate) : 0;
            
            // ë§¤ë§¤ê¸°ê°„
            const tradePeriod = firstBuyDate && lastSellDate ? calculateBusinessDays(firstBuyDate, lastSellDate) : 0;
            
            // ë°ì´í„° ì €ì¥
            const stockRecord = {
                ê¸°ë²•ëª…: strategy,
                ì‹œì´ê·œëª¨: marketCap,
                ì¢…ëª©ëª…: name,
                ë“±ìˆ˜: rank,
                ì‹ ê³ ê°€: highType,
                ì—”ë²¨ì •ì°©: envelope,
                í¬ì°©ì¼: catchDate,
                ì²«ë§¤ìˆ˜ê¸°ê°„: firstBuyPeriod,
                ë§¤ë§¤ê¸°ê°„: tradePeriod,
                ë§¤ìˆ˜ì°¨ìˆ˜: buyCount,
                í‰ë‹¨ê°€: avgPrice,
                ì´ë§¤ìˆ˜ê¸ˆì•¡: totalBuyAmount,
                ì´ë§¤ë„ê¸ˆì•¡: totalSellAmount,
                ìˆ˜ìµê¸ˆ: profit,
                ìˆ˜ìµë¥ : profitRate,
                ë§¤ìˆ˜ë‚´ì—­: buyData,
                ë§¤ë„ë‚´ì—­: sellData
            };
            
            // ë™ì¼í•œ ê¸°ë²•ëª… & ì¢…ëª©ëª…ì´ ìˆëŠ”ì§€ í™•ì¸
            const existingIndex = stockData.findIndex(stock => 
                stock.ê¸°ë²•ëª… === stockRecord.ê¸°ë²•ëª… && stock.ì¢…ëª©ëª… === stockRecord.ì¢…ëª©ëª…
            );
            
            if (existingIndex !== -1) {
                // ê¸°ì¡´ ì¢…ëª© ì—…ë°ì´íŠ¸
                stockData[existingIndex] = stockRecord;
                alert('ê¸°ì¡´ ì¢…ëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                // ìƒˆ ì¢…ëª© ì¶”ê°€
                stockData.push(stockRecord);
            }
            
            // ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updateStatsList();
            updateTotalStats();
            
            // í†µê³„ ì¹´ë“œ í‘œì‹œ
            document.getElementById('statsCard').style.display = 'block';
        }
        
        function updateStatsList() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            
            // í•„í„° ì ìš©
            const filterStrategy = document.getElementById('filterStrategy')?.value || '';
            const filterMarketCap = document.getElementById('filterMarketCap')?.value || '';
            const filterRank = document.getElementById('filterRank')?.value || '';
            const filterHighType = document.getElementById('filterHighType')?.value || '';
            const filterEnvelope = document.getElementById('filterEnvelope')?.value || '';
            const filterProfit = document.getElementById('filterProfit')?.value || '';
            
            const filteredData = stockData.filter(stock => {
                let profitSymbol = stock.ìˆ˜ìµê¸ˆ > 0 ? 'O' : (stock.ìˆ˜ìµê¸ˆ < 0 ? 'X' : 'â–²');
                
                if (filterStrategy && stock.ê¸°ë²•ëª… !== filterStrategy) return false;
                if (filterMarketCap && stock.ì‹œì´ê·œëª¨ !== filterMarketCap) return false;
                if (filterRank && stock.ë“±ìˆ˜ !== filterRank) return false;
                if (filterHighType && stock.ì‹ ê³ ê°€ !== filterHighType) return false;
                if (filterEnvelope && stock.ì—”ë²¨ì •ì°© !== filterEnvelope) return false;
                if (filterProfit && profitSymbol !== filterProfit) return false;
                
                return true;
            });
            
            filteredData.forEach((stock, index) => {
                const originalIndex = stockData.indexOf(stock);
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => showStockDetail(originalIndex);
                
                // ì‹œì´ê·œëª¨ë³„ í–‰ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
                if (stock.ì‹œì´ê·œëª¨) {
                    row.classList.add(`row-${stock.ì‹œì´ê·œëª¨}`);
                }
                
                let profitClass, profitSymbol, profitSymbolClass;
                if (stock.ìˆ˜ìµê¸ˆ > 0) {
                    profitClass = 'profit-text';
                    profitSymbol = 'O';
                    profitSymbolClass = 'profit-text';
                } else if (stock.ìˆ˜ìµê¸ˆ < 0) {
                    profitClass = 'loss-text';
                    profitSymbol = 'X';
                    profitSymbolClass = 'loss-text';
                } else {
                    profitClass = 'break-even-text';
                    profitSymbol = 'â–²';
                    profitSymbolClass = 'break-even-text';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${stock.ê¸°ë²•ëª…}</td>
                    <td>${stock.ì‹œì´ê·œëª¨}</td>
                    <td><strong>${stock.ì¢…ëª©ëª…}</strong></td>
                    <td>${stock.ë“±ìˆ˜}</td>
                    <td>${stock.ì‹ ê³ ê°€}</td>
                    <td>${stock.ì—”ë²¨ì •ì°©}</td>
                    <td>${stock.ì²«ë§¤ìˆ˜ê¸°ê°„}ì¼</td>
                    <td>${stock.ë§¤ë§¤ê¸°ê°„}ì¼</td>
                    <td>${stock.ë§¤ìˆ˜ì°¨ìˆ˜}íšŒ</td>
                    <td>${formatNumber(Math.round(stock.ì´ë§¤ìˆ˜ê¸ˆì•¡))}ì›</td>
                    <td class="${profitClass}">${stock.ìˆ˜ìµë¥ .toFixed(2)}%</td>
                    <td class="${profitClass}">${formatNumber(Math.round(stock.ìˆ˜ìµê¸ˆ))}ì›</td>
                    <td class="${profitSymbolClass}">${profitSymbol}</td>
                    <td><button class="btn-delete-row" onclick="event.stopPropagation(); deleteStockFromList(${originalIndex})">ì‚­ì œ</button></td>
                `;
                
                tbody.appendChild(row);
            });
            
            // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            updateTotalStats(filteredData);
        }
        
        function applyFilters() {
            updateStatsList();
        }
        
        function showStockDetail(index) {
            const stock = stockData[index];
            
            // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('strategyName').value = stock.ê¸°ë²•ëª…;
            document.getElementById('marketCap').value = stock.ì‹œì´ê·œëª¨ || '';
            document.getElementById('stockName').value = stock.ì¢…ëª©ëª…;
            document.getElementById('rank').value = stock.ë“±ìˆ˜;
            document.getElementById('highType').value = stock.ì‹ ê³ ê°€;
            document.getElementById('envelope').value = stock.ì—”ë²¨ì •ì°©;
            document.getElementById('catchDate').value = stock.í¬ì°©ì¼;
            
            // ë§¤ìˆ˜ ì •ë³´ ì±„ìš°ê¸°
            const buyList = document.getElementById('buyList');
            buyList.innerHTML = '';
            
            stock.ë§¤ìˆ˜ë‚´ì—­.forEach((buy, idx) => {
                const buyRow = document.createElement('div');
                buyRow.className = 'trade-row buy-row';
                buyRow.innerHTML = `
                    <div class="trade-label">${buy.ì°¨ìˆ˜}</div>
                    <div>
                        <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                        <input type="text" class="buy-date date-input" value="${buy.ë‚ ì§œ}" placeholder="250702" maxlength="10">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">D+ì¼</label>
                        <input type="text" class="buy-dday" value="${buy.ë””ë°ì´}" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                        <input type="text" class="buy-price" value="${formatNumber(buy.ë§¤ìˆ˜ê°€)}" placeholder="ê°€ê²©" inputmode="numeric">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ìˆ˜ê¸ˆì•¡</label>
                        <input type="text" class="buy-amount" value="${formatNumber(buy.ë§¤ìˆ˜ê¸ˆì•¡)}" placeholder="ê¸ˆì•¡" inputmode="numeric">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn-delete-row" onclick="deleteBuyRow(this)" ${idx === 0 && stock.ë§¤ìˆ˜ë‚´ì—­.length === 1 ? 'style="display:none;"' : ''}>ì‚­ì œ</button>
                    </div>
                `;
                buyList.appendChild(buyRow);
            });
            
            // ë§¤ë„ ì •ë³´ ì±„ìš°ê¸°
            const sellList = document.getElementById('sellList');
            sellList.innerHTML = '';
            
            stock.ë§¤ë„ë‚´ì—­.forEach((sell, idx) => {
                const sellRow = document.createElement('div');
                sellRow.className = 'trade-row sell-row';
                sellRow.innerHTML = `
                    <div class="trade-label">${sell.ì°¨ìˆ˜}</div>
                    <div>
                        <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                        <input type="text" class="sell-date date-input" value="${sell.ë‚ ì§œ}" placeholder="250702" maxlength="10">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">D+ì¼</label>
                        <input type="text" class="sell-dday" value="${sell.ë””ë°ì´}" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                        <input type="text" class="sell-price" value="${formatNumber(sell.ë§¤ë„ê°€)}" placeholder="ê°€ê²©" inputmode="numeric">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ë„ê¸ˆì•¡</label>
                        <input type="text" class="sell-amount" value="${formatNumber(sell.ë§¤ë„ê¸ˆì•¡)}" placeholder="ê¸ˆì•¡" inputmode="numeric">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn-delete-row" onclick="deleteSellRow(this)" ${idx === 0 && stock.ë§¤ë„ë‚´ì—­.length === 1 ? 'style="display:none;"' : ''}>ì‚­ì œ</button>
                    </div>
                `;
                sellList.appendChild(sellRow);
            });
            
            // ë§¤ë„ ë‚´ì—­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ 1í–‰ ì¶”ê°€
            if (stock.ë§¤ë„ë‚´ì—­.length === 0) {
                sellList.innerHTML = `
                    <div class="trade-row sell-row">
                        <div class="trade-label">1ì°¨ë§¤ë„</div>
                        <div>
                            <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                            <input type="text" class="sell-date date-input" placeholder="250702" maxlength="10">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+ì¼</label>
                            <input type="text" class="sell-dday" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                            <input type="text" class="sell-price" placeholder="ê°€ê²©" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ë§¤ë„ê¸ˆì•¡</label>
                            <input type="text" class="sell-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-delete-row" onclick="deleteSellRow(this)" style="display:none;">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }
            
            setupEventListeners();
            updateSummary();
            
            // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateTotalStats(dataToUse = null) {
            const data = dataToUse || stockData;
            
            if (data.length === 0) {
                document.getElementById('statsCard').style.display = 'none';
                return;
            }
            
            let totalInvest = 0;
            let totalProfit = 0;
            let winCount = 0;
            let maxProfitRate = -Infinity;
            let minLossRate = Infinity;
            let sumProfitRate = 0;
            
            let sumTradePeriod = 0;
            let sumFirstBuyPeriod = 0;
            let sumBuyCount = 0;
            let maxBuyCount = 0;
            const buyCountFreq = {};
            
            data.forEach(stock => {
                totalInvest += stock.ì´ë§¤ìˆ˜ê¸ˆì•¡;
                totalProfit += stock.ìˆ˜ìµê¸ˆ;
                if (stock.ìˆ˜ìµê¸ˆ > 0) winCount++;
                
                // ê°œë³„ ì¢…ëª© ìˆ˜ìµë¥  ê¸°ì¤€
                sumProfitRate += stock.ìˆ˜ìµë¥ ;
                
                if (stock.ìˆ˜ìµë¥  > maxProfitRate) maxProfitRate = stock.ìˆ˜ìµë¥ ;
                if (stock.ìˆ˜ìµë¥  < minLossRate) minLossRate = stock.ìˆ˜ìµë¥ ;
                
                // ìƒˆë¡œìš´ í†µê³„ í•­ëª© ê³„ì‚°
                sumTradePeriod += stock.ë§¤ë§¤ê¸°ê°„;
                sumFirstBuyPeriod += stock.ì²«ë§¤ìˆ˜ê¸°ê°„;
                sumBuyCount += stock.ë§¤ìˆ˜ì°¨ìˆ˜;
                if (stock.ë§¤ìˆ˜ì°¨ìˆ˜ > maxBuyCount) maxBuyCount = stock.ë§¤ìˆ˜ì°¨ìˆ˜;
                
                // ë§¤ìˆ˜ì°¨ìˆ˜ ë¹ˆë„ ê³„ì‚°
                buyCountFreq[stock.ë§¤ìˆ˜ì°¨ìˆ˜] = (buyCountFreq[stock.ë§¤ìˆ˜ì°¨ìˆ˜] || 0) + 1;
            });
            
            // í‰ê·  ìˆ˜ìµë¥  = ê° ì¢…ëª© ìˆ˜ìµë¥ ì˜ í‰ê· 
            const avgReturn = data.length > 0 ? (sumProfitRate / data.length) : 0;
            const winRate = data.length > 0 ? (winCount / data.length * 100) : 0;
            
            // ìƒˆë¡œìš´ í‰ê· ê°’ ê³„ì‚°
            const avgTradePeriod = data.length > 0 ? Math.round(sumTradePeriod / data.length) : 0;
            const avgFirstBuyPeriod = data.length > 0 ? Math.round(sumFirstBuyPeriod / data.length) : 0;
            const avgBuyCount = data.length > 0 ? (sumBuyCount / data.length).toFixed(1) : 0;
            
            // ë§¤ìˆ˜ì°¨ìˆ˜ ë¹ˆë„ ì •ë ¬ (ë¹ˆë„ê°€ ë†’ì€ ìˆœ)
            const sortedFreq = Object.entries(buyCountFreq).sort((a, b) => b[1] - a[1]);
            
            let topBuyCount = '-';
            let secondBuyCount = '-';
            let thirdBuyCount = '-';
            
            if (sortedFreq[0]) {
                const topCount = sortedFreq[0][0];
                const topFreq = sortedFreq[0][1];
                const topPercent = ((topFreq / data.length) * 100).toFixed(1);
                topBuyCount = `${topCount}ì°¨ë§¤ìˆ˜ / (${topPercent}%)`;
            }
            
            if (sortedFreq[1]) {
                const secondCount = sortedFreq[1][0];
                const secondFreq = sortedFreq[1][1];
                const secondPercent = ((secondFreq / data.length) * 100).toFixed(1);
                secondBuyCount = `${secondCount}ì°¨ë§¤ìˆ˜ / (${secondPercent}%)`;
            }
            
            if (sortedFreq[2]) {
                const thirdCount = sortedFreq[2][0];
                const thirdFreq = sortedFreq[2][1];
                const thirdPercent = ((thirdFreq / data.length) * 100).toFixed(1);
                thirdBuyCount = `${thirdCount}ì°¨ë§¤ìˆ˜ / (${thirdPercent}%)`;
            }
            
            // ê¸°ì¡´ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalStocks').textContent = data.length;
            document.getElementById('totalInvest').textContent = formatNumber(Math.round(totalInvest)) + 'ì›';
            document.getElementById('totalProfit').textContent = formatNumber(Math.round(totalProfit)) + 'ì›';
            document.getElementById('avgReturn').textContent = avgReturn.toFixed(2) + '%';
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('maxProfitRate').textContent = (maxProfitRate === -Infinity ? 0 : maxProfitRate).toFixed(2) + '%';
            
            // ìµœëŒ€ ì†ì‹¤ë¥  í‘œì‹œ ë¡œì§ ìˆ˜ì •
            if (minLossRate >= 0) {
                // ëª¨ë“  ì¢…ëª©ì´ ìˆ˜ìµì´ê±°ë‚˜ ë³¸ì „ì´ë©´ "-" í‘œì‹œ
                document.getElementById('maxLossRate').textContent = '-';
            } else {
                document.getElementById('maxLossRate').textContent = minLossRate.toFixed(2) + '%';
            }
            
            // ìƒˆë¡œìš´ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('avgTradePeriod').textContent = avgTradePeriod + 'ì¼';
            document.getElementById('avgFirstBuyPeriod').textContent = avgFirstBuyPeriod + 'ì¼';
            document.getElementById('avgBuyCount').textContent = avgBuyCount + 'íšŒ';
            document.getElementById('maxBuyCount').textContent = maxBuyCount + 'íšŒ';
            document.getElementById('topBuyCount').textContent = topBuyCount;
            document.getElementById('secondBuyCount').textContent = secondBuyCount;
            document.getElementById('thirdBuyCount').textContent = thirdBuyCount;
            
            // ìƒ‰ìƒ
            const profitEl = document.getElementById('totalProfit');
            const returnEl = document.getElementById('avgReturn');
            if (totalProfit > 0) {
                profitEl.style.color = '#f44336';
                returnEl.style.color = '#f44336';
            } else if (totalProfit < 0) {
                profitEl.style.color = '#2196f3';
                returnEl.style.color = '#2196f3';
            } else {
                profitEl.style.color = '#333';
                returnEl.style.color = '#333';
            }
            
            document.getElementById('statsCard').style.display = 'block';
        }
        
        function deleteStockFromList(index) {
            if (confirm('ì´ ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                stockData.splice(index, 1);
                updateStatsList();
                updateTotalStats();
                
                if (stockData.length === 0) {
                    document.getElementById('statsCard').style.display = 'none';
                }
            }
        }
        
        function resetInputForm() {
            document.getElementById('strategyName').value = '';
            document.getElementById('marketCap').value = '';
            document.getElementById('stockName').value = '';
            document.getElementById('rank').value = '';
            document.getElementById('highType').value = '';
            document.getElementById('envelope').value = '';
            document.getElementById('catchDate').value = '';
            
            // ë§¤ìˆ˜/ë§¤ë„ í–‰ ì´ˆê¸°í™”
            document.getElementById('buyList').innerHTML = `
                <div class="trade-row buy-row">
                    <div class="trade-label">1ì°¨ë§¤ìˆ˜</div>
                    <div>
                        <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                        <input type="text" class="buy-date date-input" placeholder="250702" maxlength="10">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">D+ì¼</label>
                        <input type="text" class="buy-dday" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                        <input type="text" class="buy-price" placeholder="ê°€ê²©" inputmode="numeric">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ìˆ˜ê¸ˆì•¡</label>
                        <input type="text" class="buy-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="display:none;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            
            document.getElementById('sellList').innerHTML = `
                <div class="trade-row sell-row">
                    <div class="trade-label">1ì°¨ë§¤ë„</div>
                    <div>
                        <label style="font-size: 0.85em;">ë‚ ì§œ</label>
                        <input type="text" class="sell-date date-input" placeholder="250702" maxlength="10">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">D+ì¼</label>
                        <input type="text" class="sell-dday" readonly style="background: #f5f5f5;">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                        <input type="text" class="sell-price" placeholder="ê°€ê²©" inputmode="numeric">
                    </div>
                    <div>
                        <label style="font-size: 0.85em;">ë§¤ë„ê¸ˆì•¡</label>
                        <input type="text" class="sell-amount" placeholder="ê¸ˆì•¡" inputmode="numeric">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn-delete-row" onclick="deleteSellRow(this)" style="display:none;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            
            setupEventListeners();
            updateSummary();
        }
        
        function exportToExcel() {
            if (stockData.length === 0) {
                alert('í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // ì „ì²´ ìš”ì•½ ì‹œíŠ¸
            const summary_data = [
                ['ê¸°ë²•ëª…', 'ì¢…ëª©ëª…', 'ë“±ìˆ˜', 'ì‹ ê³ ê°€', 'ì—”ë²¨ì •ì°©', 'í¬ì°©ì¼', 'ì²«ë§¤ìˆ˜ê¸°ê°„', 'ë§¤ë§¤ê¸°ê°„', 'ë§¤ìˆ˜ì°¨ìˆ˜', 'í‰ë‹¨ê°€', 'ì´ë§¤ìˆ˜ê¸ˆì•¡', 'ì´ë§¤ë„ê¸ˆì•¡', 'ìˆ˜ìµê¸ˆ', 'ìˆ˜ìµë¥ (%)']
            ];
            
            stockData.forEach(stock => {
                summary_data.push([
                    stock.ê¸°ë²•ëª…,
                    stock.ì¢…ëª©ëª…,
                    stock.ë“±ìˆ˜,
                    stock.ì‹ ê³ ê°€,
                    stock.ì—”ë²¨ì •ì°©,
                    stock.í¬ì°©ì¼,
                    stock.ì²«ë§¤ìˆ˜ê¸°ê°„ + 'ì¼',
                    stock.ë§¤ë§¤ê¸°ê°„ + 'ì¼',
                    stock.ë§¤ìˆ˜ì°¨ìˆ˜ + 'íšŒ',
                    Math.round(stock.í‰ë‹¨ê°€),
                    Math.round(stock.ì´ë§¤ìˆ˜ê¸ˆì•¡),
                    Math.round(stock.ì´ë§¤ë„ê¸ˆì•¡),
                    Math.round(stock.ìˆ˜ìµê¸ˆ),
                    stock.ìˆ˜ìµë¥ .toFixed(2)
                ]);
            });
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summary_data);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'ì „ì²´ìš”ì•½');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const today = new Date();
            const dateStr = today.getFullYear() + 
                           String(today.getMonth() + 1).padStart(2, '0') + 
                           String(today.getDate()).padStart(2, '0');
            const filename = `ë§¤ë§¤í†µê³„_${dateStr}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }
        
        function resetAll() {
            if (confirm('ì…ë ¥ í¼ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í†µê³„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
                resetInputForm();
            }
        }
        
        // ========== Google Drive API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';  // OAuthë§Œ ì‚¬ìš©
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'trading_stats_backup.json';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;  // ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥
        let tokenRefreshTimer = null;
        
        // ========== GAPI ì´ˆê¸°í™” ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
        }
        
        // ========== GIS ì´ˆê¸°í™” ==========
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
        }
        
        // ========== êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬ ==========
        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    localStorage.setItem('google_access_token', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry', expiryTime.toString());
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };
                
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }
        
        // ========== í† í° ìë™ ê°±ì‹  ==========
        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                localStorage.setItem('google_access_token', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry', expiryTime.toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                gapi.client.setToken({access_token: resp.access_token});
                            }
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ìë™ ê°±ì‹  ì‹¤íŒ¨:', err);
                    }
                }
            }, refreshTime);
        }
        
        // ========== ë¡œê·¸ì¸ ìƒíƒœ ë³µì› ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token');
            const tokenExpiry = localStorage.getItem('google_token_expiry');
            
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({access_token: savedToken});
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    await loadFromGoogleDrive();
                } else {
                    localStorage.removeItem('google_access_token');
                    localStorage.removeItem('google_token_expiry');
                }
            }
        }
        
        // ========== ë™ê¸°í™” ìƒíƒœ í‘œì‹œ ==========
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }
        
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ì°¾ê¸° ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                return null;
            }
        }
        
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    const data = JSON.parse(response.body);
                    stockData = data.stockData || [];
                    updateStatsList();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    console.log('âœ“ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ì¢…ëª© ìˆ˜: ' + stockData.length + ')');
                } else {
                    updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
                    console.log('ì €ì¥ëœ ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
            }
        }
        
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥ ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                const dataToSave = {
                    stockData: stockData,
                    lastUpdated: new Date().toISOString()
                };
                
                const data = JSON.stringify(dataToSave, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    // ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ (PATCH)
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    console.log('âœ“ ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    // ìƒˆ íŒŒì¼ ìƒì„± (POST)
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                    
                    console.log('âœ“ ìƒˆ íŒŒì¼ ìƒì„± ì™„ë£Œ (ID: ' + driveFileId + ')');
                }
                
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                console.log('âœ“ ë°ì´í„° ì €ì¥ ì™„ë£Œ (ì¢…ëª© ìˆ˜: ' + stockData.length + ')');
            } catch (err) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)');
            }
        }
        
        // ========== ìˆ˜ë™ ë°±ì—… ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        // ========== ìˆ˜ë™ ë¡œë“œ ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                await loadFromGoogleDrive();
                alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        // ========== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ==========
        window.addEventListener('load', async function() {
            // êµ¬ê¸€ API ì´ˆê¸°í™”
            gapiLoaded();
            gisLoaded();
            
            // ì´ˆê¸°í™” ëŒ€ê¸° í›„ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        });
        
        // ========== í˜ì´ì§€ ì¢…ë£Œ ì‹œ ìë™ ë°±ì—… ==========
        window.addEventListener('beforeunload', function(e) {
            if (isSignedIn && stockData.length > 0) {
                // ë°±ì—… ì‹œë„ (ë¹„ë™ê¸°ì§€ë§Œ ìµœì„ ì„ ë‹¤í•¨)
                saveToGoogleDrive();
            }
        });
        
        // ì´ˆê¸°í™”
        createStockInput();
    </script>
</body>
</html>
